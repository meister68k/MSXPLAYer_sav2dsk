# MSXPLAYerの仮想ディスクをべたイメージに変換する

2022-09-24 programmed by Meister

## 概要

MSXPLAYer[^1]の仮想ディスクである，.savファイルを2DDのべたイメージと相互変換します。変換後のイメージファイルは[ND](https://euee.web.fc2.com/tool/nd.html)等の仮想ディスクイメージ操作ツールでの編集や，Common Source Code Project [yayaMSX2+](http://takeda-toshiya.my.coocan.jp/msx/index.html)等のエミュレータでの使用が可能です。


## 使用方法

### .savファイルからべたイメージ(.2DD)に変換する
```
sav2dsk.exe [--ext 拡張子] 変換対象のファイル名
  --ext 変換後の拡張子(デフォルト：.2DD)
```

### べたイメージ(.2DD)から.savファイルに変換する
```
dsk2sav.exe [--skip スキップするセクタ数] 変換対象のファイル名
  --skip 変換をスキップするセクタ数(デフォルト：1)
```

## 注意点

1. .savファイルは元となるイメージファイル(.dskファイル)に対する差分データだと思われます。このツールでは空のイメージに対する差分，つまり**MSXPLAYerで言うところの仮想フロッピーディスクCとDのみ対応**しています。
2. 1項の制約により，フォーマットでBPB(OSが参照するディスク容量などの情報)とIPLが書き込まれる第0セクタの内容を取り出すことができません。sav2dskでは適当なBPBを生成しています。
3. dsk2savでスキップするセクタ数は，2項の事情による正しくない第0セクタを切り捨てるための指定です。
4. dsk2savではディスク全域を.savに出力するため，差分のみで生成される本来の.savよりも容量が大きくなります。実害はありません。
5. sav2dskで拡張子を変更しても出力内容は変わりません。

## 技術情報

以下は独自の解析結果のため，内容の正確性を保証できません。

### .savファイルの構造

```
[セクタ番号4バイト] [セクタの内容512バイト] [セクタ番号4バイト] [セクタの内容512バイト] ...
```

セクタ番号のバイトオーダは下位バイト→上位バイトの順(いわゆるリトルエンディアン)

### .dskファイルの所在

.savファイルの差分の元となるものは.dskファイルであり，こちらは720KB 2DDのべたイメージとなっています。所在はエミュレータ実行ファイルと同じフォルダにある.imgファイル(例えば C:\Program Files (x86)\ASCII\MSX MAGAZINE 2003 BASIC(blue)\basic.img)の内部。
.imgファイルはzip形式の圧縮ファイルで，その中のmsx\img\ascii\mmag2003\フォルダに.dskファイルが格納されています。


## 参考文献

[^1]: MSX MAGAZINE 永久保存版,  MSXアソシエーション(著), アスキー書籍編集部(編), アスキー, 2003, ISBN 978-4756142108 

## ライセンス

本プログラム\(ソース・バイナリ含む\)およびドキュメント一式について，CC0ライセンス
\( http://creativecommons.org/publicdomain/zero/1.0/deed.ja \)を宣言します。
